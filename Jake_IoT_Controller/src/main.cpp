#include <NeoPixelConnect.h>  // NeoPixel LED 라이브러리
#include <DHT.h>              // DHT 온습도 센서 라이브러리
#include <Adafruit_GFX.h>     // Adafruit 그래픽 라이브러리 (OLED 디스플레이 지원)
#include <Adafruit_SSD1306.h> // Adafruit OLED 디스플레이 라이브러리

#define DEBUG_MODE_ENABLE 1

// NeoPixel LED 설정
#define PIXEL_CONTROL_PIN 15
#define MAXIMUM_NUM_NEOPIXELS 12

// DHT 온습도 센서 설정
#define DHT_PIN 2
#define DHTTYPE DHT11

// OLED 디스플레이 설정
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 32
#define OLED_RESET -1
#define SCREEN_ADDRESS 0x3C

// 초기 화면 표시 시간 (5초 동안 초기 화면 표시 후 센서 데이터 표시)
const long displayDelay = 5000;

// 전역 변수 선언
unsigned char redColor = 0, greenColor = 0, blueColor = 0;
float fHumidity, fTemperature;
bool flgEmotionalModeEnable = true;
bool flgInitialDisplayDone = false;
unsigned long previousMillis = 0;

// OLED 초기 화면 비트맵 데이터 (로고나 초기 화면 이미지)
static const unsigned char epd_bitmap_oled_background[] PROGMEM = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x80, 0x00, 0x01, 0xa0, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xfd, 0x83, 0xfc, 0x80, 0x18, 0xf9, 0xb3, 0xfe, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xf9, 0x80, 0x00, 0xbf, 0x98, 0xf9, 0xb3, 0xfe, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0x81, 0x81, 0x98, 0x9f, 0x98, 0x8d, 0xb0, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xfd, 0x80, 0x90, 0x80, 0x98, 0x8f, 0xb3, 0xfe, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0x81, 0x80, 0xf0, 0x9f, 0x9e, 0x8d, 0xb3, 0xfe, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xfd, 0x83, 0xfc, 0x9f, 0x9e, 0xf9, 0xb3, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x3c, 0x00, 0x01, 0xfd, 0x80, 0x00, 0x98, 0x18, 0xf9, 0xb3, 0xfe, 0x00, 0x00, 0x3c, 0x00,
    0x00, 0xc3, 0x00, 0x00, 0x00, 0x00, 0xff, 0x98, 0x18, 0x01, 0xb3, 0xfe, 0x00, 0x00, 0xc3, 0x00,
    0x01, 0x00, 0x80, 0x00, 0xff, 0x80, 0x01, 0x9f, 0x98, 0x30, 0x00, 0x00, 0x00, 0x01, 0x00, 0x80,
    0x02, 0x3c, 0x40, 0x00, 0xff, 0x80, 0xff, 0x9f, 0xd8, 0x30, 0x07, 0xff, 0x00, 0x02, 0x3c, 0x40,
    0x02, 0x3c, 0x40, 0x00, 0x80, 0x80, 0xff, 0x80, 0x18, 0x38, 0x07, 0xff, 0x80, 0x02, 0x3c, 0x40,
    0x04, 0x32, 0x20, 0x00, 0xff, 0x80, 0xff, 0x80, 0x18, 0x3f, 0xf0, 0x00, 0x00, 0x04, 0x32, 0x20,
    0x04, 0x3e, 0x20, 0x00, 0xff, 0x80, 0xff, 0x80, 0x18, 0x00, 0x00, 0x00, 0x00, 0x04, 0x3e, 0x20,
    0x04, 0x26, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x26, 0x20,
    0x04, 0x62, 0x21, 0x80, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x80, 0x07, 0x04, 0x62, 0x20,
    0x02, 0x7e, 0x41, 0x80, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x01, 0x80, 0x07, 0x02, 0x7e, 0x40,
    0x02, 0x30, 0x41, 0x80, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x07, 0x02, 0x30, 0x40,
    0x01, 0x00, 0x81, 0x80, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x07, 0x01, 0x00, 0x80,
    0x00, 0xc3, 0x01, 0x9f, 0x8f, 0xc7, 0xcf, 0xef, 0xc0, 0xf1, 0xf9, 0x9f, 0xc7, 0x00, 0xc3, 0x00,
    0x00, 0x3c, 0x01, 0x9f, 0xcc, 0x4c, 0xcf, 0xe7, 0x01, 0xf9, 0xf9, 0x9f, 0xe7, 0x00, 0x3c, 0x00,
    0x00, 0x00, 0x01, 0x98, 0xce, 0x0c, 0x6e, 0x07, 0x01, 0x83, 0x8d, 0x9c, 0x67, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x98, 0x47, 0x8f, 0xee, 0x07, 0x01, 0x83, 0x0d, 0x9c, 0x67, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x98, 0x41, 0xcc, 0x0e, 0x07, 0x01, 0x83, 0x0d, 0x9c, 0x67, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x98, 0x40, 0xec, 0x6e, 0x07, 0x01, 0x8b, 0x8d, 0x9c, 0x60, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x98, 0x4f, 0xcf, 0xee, 0x07, 0x01, 0xf9, 0xf9, 0x9c, 0x60, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x98, 0x47, 0x87, 0xce, 0x07, 0x00, 0xf0, 0xf1, 0x9c, 0x67, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

// 객체 생성 (NeoPixel, DHT 센서, OLED 디스플레이)
NeoPixelConnect myLEDStrip(PIXEL_CONTROL_PIN, MAXIMUM_NUM_NEOPIXELS, pio0, 0);
DHT myDHT(DHT_PIN, DHTTYPE);
Adafruit_SSD1306 myOledDisplay(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// 함수 선언 (프로토타이핑)
void initializeOLED();
void displaySensorData(float temperature, float humidity);

// 초기 설정 함수 (한 번만 실행)
void setup()
{
  Serial.begin(115200);
  myDHT.begin();
  Wire.begin();
  initializeOLED();
}

// 메인 루프 (계속 반복 실행)
void loop()
{
  unsigned long currentMillis = millis();

  if (!flgInitialDisplayDone && currentMillis - previousMillis >= displayDelay)
  {
    flgInitialDisplayDone = true;
    myOledDisplay.clearDisplay();
  }

  if (flgInitialDisplayDone)
  {
    fHumidity = myDHT.readHumidity();
    fTemperature = myDHT.readTemperature();

#if (DEBUG_MODE_ENABLE == 1)
    Serial.print("Humidity: ");
    Serial.print(fHumidity);
    Serial.print("%   Temperature: ");
    Serial.print(fTemperature);
    Serial.println("^C");
#endif

    displaySensorData(fTemperature, fHumidity);

    // 온도에 따라 NeoPixel LED 색상 설정- 추후 조건에 따라 함수화
    if (fTemperature >= 32)
    {
      redColor = 255;
      greenColor = 89;
      blueColor = 89;
    }
    else if (fTemperature >= 26)
    {
      redColor = 254;
      greenColor = 155;
      blueColor = 120;
    }
    else if (fTemperature >= 18)
    {
      redColor = 255;
      greenColor = 255;
      blueColor = 255;
    }
    else if (fTemperature >= 0)
    {
      redColor = 58;
      greenColor = 199;
      blueColor = 131;
    }
    else
    {
      redColor = 126;
      greenColor = 225;
      blueColor = 225;
    }

    myLEDStrip.neoPixelFill(redColor, greenColor, blueColor, true);
  }
}

// OLED 초기화 및 초기 화면 표시 함수
void initializeOLED()
{
  if (!myOledDisplay.begin(SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS))
  {
#if (DEBUG_MODE_ENABLE == 1)
    Serial.println(F("SSD1306 allocation failed"));
#endif
    for (;;)
      ;
  }

  myOledDisplay.clearDisplay();
  myOledDisplay.drawBitmap(0, 0, epd_bitmap_oled_background, 128, 32, 1);
  myOledDisplay.display();

  previousMillis = millis();
}

// OLED에 온도 및 습도 데이터 표시 함수
void displaySensorData(float temperature, float humidity)
{
  myOledDisplay.clearDisplay();
  myOledDisplay.setTextSize(1);
  myOledDisplay.setTextColor(SSD1306_WHITE);
  myOledDisplay.setCursor(0, 0);

  myOledDisplay.print("Temp: ");
  myOledDisplay.print(temperature);
  myOledDisplay.print((char)247);
  myOledDisplay.println("C");

  myOledDisplay.print("Hum: ");
  myOledDisplay.print(humidity);
  myOledDisplay.println("%");

  myOledDisplay.display();
}